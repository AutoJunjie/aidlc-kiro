# ADR-002: 使用 PostgreSQL 作为主数据库

## 状态
Accepted

## 日期
2025-11-10

## 背景

XHolacracy MVP 需要一个可靠的数据库来存储组织结构、角色、提案、会议等数据。系统需要：
1. 支持复杂的关系模型（组织层次结构、角色分配、提案流程等）
2. 保证数据一致性（ACID 事务）
3. 支持高效的查询（层次查询、关系查询）
4. 预期支持 200 名用户规模
5. 开源且成本可控

## 决策

我们决定使用 **PostgreSQL** 作为 XHolacracy MVP 的主数据库。

选择理由：
1. **强大的关系模型支持**：完整的 SQL 标准支持，适合复杂的关系数据
2. **ACID 事务保证**：确保数据一致性，特别是在提案审批和会议流程中
3. **丰富的数据类型**：支持 JSON/JSONB，可以灵活存储非结构化数据
4. **优秀的查询性能**：支持多种索引类型（B-tree, Hash, GiST, GIN 等）
5. **层次查询支持**：WITH RECURSIVE 支持圈子层次结构查询
6. **成熟稳定**：经过多年验证，社区活跃
7. **开源免费**：无许可证成本

## 替代方案

### 方案 1: MySQL
流行的开源关系型数据库。

**优点**:
- 广泛使用，社区庞大
- 简单易用
- 性能良好
- 开源免费

**缺点**:
- JSON 支持不如 PostgreSQL 完善
- 复杂查询性能不如 PostgreSQL
- 事务隔离级别支持有限
- 递归查询支持较弱

**为什么没有选择**: PostgreSQL 在复杂查询、JSON 支持和事务处理方面更强大，更适合我们的业务需求。

### 方案 2: MongoDB
流行的 NoSQL 文档数据库。

**优点**:
- 灵活的文档模型
- 水平扩展容易
- JSON 原生支持
- 适合快速迭代

**缺点**:
- 缺乏 ACID 事务支持（多文档事务性能差）
- 关系查询复杂
- 数据一致性保证较弱
- 不适合复杂的关系模型

**为什么没有选择**: Holacracy 的数据模型是高度关系化的（组织-圈子-角色-伙伴），NoSQL 数据库不适合这种场景。而且我们需要强 ACID 保证来确保提案和会议流程的数据一致性。

### 方案 3: Oracle Database
企业级商业数据库。

**优点**:
- 功能强大
- 性能优秀
- 企业级支持
- 成熟稳定

**缺点**:
- 商业许可证昂贵
- 部署和维护复杂
- 对于 MVP 来说过度设计
- 不符合开源策略

**为什么没有选择**: 成本过高，对于 MVP 阶段不必要。PostgreSQL 能够满足所有需求且免费。

### 方案 4: SQLite
轻量级嵌入式数据库。

**优点**:
- 零配置
- 轻量级
- 适合小型应用
- 开源免费

**缺点**:
- 不支持并发写入
- 不适合多用户场景
- 功能有限
- 不支持网络访问

**为什么没有选择**: 系统需要支持 200 个并发用户，SQLite 不适合多用户场景。

## 后果

### 正面影响
- **数据一致性保证**：ACID 事务确保提案审批和会议流程的数据完整性
- **查询性能优秀**：支持复杂的 JOIN 和层次查询，满足圈子层次结构和角色关系查询需求
- **灵活的数据存储**：JSONB 类型可以存储提案的决策历史等非结构化数据
- **成本可控**：开源免费，无许可证费用
- **社区支持**：活跃的社区，丰富的文档和工具
- **扩展性**：支持水平扩展（通过分片或读写分离）
- **开发效率**：Spring Data JPA 对 PostgreSQL 支持良好

### 负面影响
- **运维复杂度**：相比 SQLite 需要独立部署和维护
- **资源消耗**：相比轻量级数据库需要更多内存和存储
- **学习曲线**：团队需要熟悉 PostgreSQL 特性和优化技巧

### 风险
- **性能瓶颈**：如果查询设计不当或索引缺失，可能出现性能问题
- **数据迁移**：未来如果需要切换数据库，迁移成本较高
- **备份恢复**：需要建立完善的备份和恢复机制

### 缓解措施
- 在设计阶段规划好索引策略
- 使用 EXPLAIN ANALYZE 分析慢查询并优化
- 使用连接池（HikariCP）管理数据库连接
- 实施定期备份策略（pg_dump）
- 监控数据库性能指标
- 使用 JPA 抽象层，降低数据库切换成本

## 相关决策
- [ADR-001](./001-adopt-ddd-architecture.md): 采用领域驱动设计（DDD）架构

## 参考资料
- [PostgreSQL Official Documentation](https://www.postgresql.org/docs/)
- [Spring Data JPA with PostgreSQL](https://spring.io/guides/gs/accessing-data-jpa/)
- [PostgreSQL Performance Tuning](https://wiki.postgresql.org/wiki/Performance_Optimization)
